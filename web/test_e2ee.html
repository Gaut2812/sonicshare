<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>E2EE Test | SonicShare</title>
    <link rel="stylesheet" href="/static/style.css" />
    <style>
      .test-box {
        margin: 1.5rem 0;
        padding: 1.5rem;
        background: rgba(0, 0, 0, 0.3);
        border-radius: 12px;
        border: 1px solid var(--glass-border);
      }
      .status-good {
        color: #10b981;
        font-weight: bold;
      }
      .status-bad {
        color: #ef4444;
        font-weight: bold;
      }
      .status-warn {
        color: #fbbf24;
        font-weight: bold;
      }
      .code-block {
        background: #000;
        padding: 1rem;
        border-radius: 8px;
        font-family: monospace;
        font-size: 0.85rem;
        overflow-x: auto;
        margin: 0.5rem 0;
      }
    </style>
  </head>
  <body>
    <div class="container">
      <div class="card">
        <h2 style="font-size: 2rem">üîê E2EE Verification Test</h2>
        <p>Step 13: End-to-End Encryption Status Check</p>

        <div class="test-box">
          <h3>üîç Security Context</h3>
          <div id="security-status"></div>
        </div>

        <div class="test-box">
          <h3>üìã Test Checklist</h3>
          <div style="font-size: 0.9rem; line-height: 1.8">
            <div>‚úÖ <strong>ECDH Key Exchange:</strong> P-256 curve</div>
            <div>‚úÖ <strong>Symmetric Encryption:</strong> AES-GCM 256-bit</div>
            <div>‚úÖ <strong>API:</strong> Web Crypto API (native)</div>
            <div>‚úÖ <strong>Server:</strong> Blind relay (no decryption)</div>
            <div>‚úÖ <strong>Resume:</strong> Works with encrypted chunks</div>
          </div>
        </div>

        <div class="test-box">
          <h3>üß™ How to Test</h3>
          <ol style="line-height: 1.8; color: var(--text-secondary)">
            <li>
              <strong>HTTPS Mode:</strong> Deploy to HTTPS server or use
              localhost with SSL
            </li>
            <li>
              <strong>HTTP Mode:</strong> Encryption disabled (shows warning
              badge)
            </li>
            <li><strong>Open DevTools:</strong> F12 ‚Üí Network tab</li>
            <li>
              <strong>Start Transfer:</strong> Send a file between sender and
              receiver
            </li>
            <li>
              <strong>Inspect Packets:</strong> Look for DATA packets in Network
              tab
            </li>
            <li>
              <strong>Verify:</strong> Payload should be base64 encrypted blob
            </li>
          </ol>
        </div>

        <div class="test-box">
          <h3>üîê What to Look For</h3>

          <h4 style="margin-top: 1rem; color: var(--accent)">
            Console Logs (Secure Mode):
          </h4>
          <div class="code-block">
            üîê Generating ECDH (P-256) keys... üì° Sending Public Key...
            Processing peer key... üîê Secure channel established Secure channel
            derived
          </div>

          <h4 style="margin-top: 1rem; color: var(--accent)">
            Console Logs (Local Mode):
          </h4>
          <div class="code-block">
            ‚ö†Ô∏è INSECURE CONTEXT: Encryption disabled. Local Network Mode active.
            üîì Connected (Local Mode) Using Local Mode (No Encryption)
          </div>

          <h4 style="margin-top: 1rem; color: var(--accent)">
            Network Tab (DATA Packet):
          </h4>
          <div class="code-block">
            { "type": "DATA", "code": "709490", "seq": 5, "iv":
            "a8f3d9e2c1b4...", ‚Üê Random IV "payload": "xK9mP3vL..." ‚Üê Encrypted
            base64 }
          </div>
        </div>

        <div class="test-box">
          <h3>‚úÖ Success Criteria</h3>
          <div style="line-height: 1.8; color: var(--text-secondary)">
            <div>‚úÖ File transfers work in both secure and local modes</div>
            <div>‚úÖ Server logs show unreadable encrypted payloads</div>
            <div>‚úÖ Network tab shows encrypted blobs (not plain text)</div>
            <div>‚úÖ Received file opens correctly (decryption works)</div>
            <div>‚úÖ Resume still works with encrypted chunks</div>
            <div>‚úÖ ACK system works with encryption</div>
          </div>
        </div>

        <div class="test-box">
          <h3>üöÄ Quick Test Actions</h3>
          <div style="display: flex; gap: 1rem; margin-top: 1rem">
            <button
              class="btn"
              onclick="window.open('/', '_blank')"
              style="flex: 1"
            >
              Open Sender
            </button>
            <button
              class="btn btn-secondary"
              onclick="window.open('/receiver.html', '_blank')"
              style="flex: 1"
            >
              Open Receiver
            </button>
          </div>
        </div>

        <a href="index.html" class="back-link">&larr; Back to Home</a>
      </div>
    </div>

    <script>
      const IS_SECURE = window.isSecureContext;
      const statusDiv = document.getElementById("security-status");

      if (IS_SECURE) {
        statusDiv.innerHTML = `
                <div class="status-good">‚úÖ SECURE CONTEXT DETECTED</div>
                <div style="margin-top: 0.5rem; color: var(--text-secondary);">
                    End-to-end encryption is <strong>ENABLED</strong>.<br>
                    All file transfers will be encrypted with AES-GCM 256-bit.
                </div>
            `;
      } else {
        statusDiv.innerHTML = `
                <div class="status-warn">‚ö†Ô∏è INSECURE CONTEXT (HTTP)</div>
                <div style="margin-top: 0.5rem; color: var(--text-secondary);">
                    Encryption is <strong>DISABLED</strong> (Local Mode).<br>
                    Files transfer in plain text. Use HTTPS for encryption.
                </div>
            `;
      }

      // Check if Web Crypto API is available
      if (crypto && crypto.subtle) {
        const apiStatus = document.createElement("div");
        apiStatus.style.marginTop = "0.5rem";
        apiStatus.innerHTML =
          '<div class="status-good">‚úÖ Web Crypto API Available</div>';
        statusDiv.appendChild(apiStatus);
      } else {
        const apiStatus = document.createElement("div");
        apiStatus.style.marginTop = "0.5rem";
        apiStatus.innerHTML =
          '<div class="status-bad">‚ùå Web Crypto API Not Available</div>';
        statusDiv.appendChild(apiStatus);
      }
    </script>
  </body>
</html>
